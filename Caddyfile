{$DOMAIN} {
    # Reverse proxy to n8n
    reverse_proxy n8n:5678 {
        # Required for SSE/WebSocket (n8n uses these)
        flush_interval -1
    }

    # Remove n8n's default X-Frame-Options to allow iframe embedding
    header -X-Frame-Options

    # Set Content-Security-Policy to only allow embedding from our domains
    header Content-Security-Policy "frame-ancestors {$ALLOWED_IFRAME_ORIGINS}"

    # Security headers (keep the good ones)
    header X-Content-Type-Options "nosniff"
    header Referrer-Policy "strict-origin-when-cross-origin"

    # CORS headers for API requests from our frontend
    @cors_preflight method OPTIONS
    handle @cors_preflight {
        header Access-Control-Allow-Origin "{$ALLOWED_IFRAME_ORIGINS}"
        header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        header Access-Control-Allow-Headers "Content-Type, Authorization, X-NodeBench-Token"
        header Access-Control-Max-Age "86400"
        respond 204
    }

    # Add CORS headers to all responses
    header Access-Control-Allow-Origin "*"
    header Access-Control-Allow-Credentials "true"
}
